name: Deploy GitHub Pages previews

on:
  push:
    branches: ["**"]
  workflow_dispatch:
    inputs:
      target_branch:
        description: Branch to deploy (defaults to main when blank)
        required: false
        default: ''

permissions:
  contents: write
  actions: read
  deployments: write
  pull-requests: read

env:
  BASE_PREVIEW_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}

jobs:
  deploy:
    name: Deploy branch preview
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-pages-${{ github.ref_name }}
      cancel-in-progress: false
    outputs:
      branch: ${{ steps.compute.outputs.branch }}
      ref: ${{ steps.compute.outputs.ref }}
      safe_branch: ${{ steps.compute.outputs.safe_branch }}
      deploy_key: ${{ steps.compute.outputs.deploy_key }}
      pr_number: ${{ steps.compute.outputs.pr_number }}
      target_dir: ${{ steps.compute.outputs.target_dir }}
      preview_url: ${{ steps.compute.outputs.preview_url }}
      should_deploy: ${{ steps.compute.outputs.should_deploy }}
    steps:
      - name: Derive deployment target
        id: compute
        uses: actions/github-script@v7
        with:
          script: |
            const inputBranch = core.getInput('target_branch');

            const sanitize = (value) => (value || '').replace(/[^a-zA-Z0-9._-]/g, '-').trim();

            const resolveBranchRef = async (branchName) => {
              if (!branchName) {
                return { branch: '', ref: '' };
              }
              const { data } = await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName,
              });
              return { branch: branchName, ref: data?.commit?.sha || '' };
            };

            const findPullRequest = async (branchName) => {
              if (!branchName) {
                return null;
              }

              const { data } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branchName}`,
                state: 'open',
                sort: 'updated',
                direction: 'desc',
                per_page: 1,
              });

              return Array.isArray(data) && data.length > 0 ? data[0] : null;
            };

            try {
              const eventName = context.eventName;
              let branch = '';
              let ref = '';
              let prNumber = '';
              let shouldDeploy = false;

              if (eventName === 'push') {
                branch = (context.payload.ref || '').replace('refs/heads/', '');
                ref = context.sha;
              } else if (eventName === 'workflow_dispatch') {
                const target = inputBranch || 'main';
                const resolved = await resolveBranchRef(target);
                branch = resolved.branch;
                ref = resolved.ref;
              }

              if (!branch) {
                const message = 'No branch could be resolved for deployment.';
                await core.summary.addHeading('Deployment failed').addRaw(message).write();
                core.setFailed(message);
                return;
              }

              const safeBranch = sanitize(branch) || branch;
              const isMain = branch === 'main';

              const pullRequest = isMain ? null : await findPullRequest(branch);

              if (isMain) {
                shouldDeploy = true;
              } else if (pullRequest?.number) {
                prNumber = String(pullRequest.number);
                shouldDeploy = true;
              } else {
                const message = `No open pull request found for branch '${branch}'. Branch previews require an associated PR.`;
                await core.summary.addHeading('Deployment skipped').addRaw(`${message}\n`).write();
                core.info(message);
              }

              const targetDir = shouldDeploy ? (isMain ? '.' : `pull/${prNumber}`) : '';

              const baseUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}`;
              const previewUrl = shouldDeploy
                ? isMain
                  ? `${baseUrl}/`
                  : `${baseUrl}/${targetDir}/`
                : '';

              const details = [
                `branch: ${branch}`,
                `pr: ${prNumber || 'none'}`,
                `targetDir: ${targetDir || 'n/a'}`,
                `previewUrl: ${previewUrl || 'n/a'}`,
                `shouldDeploy: ${shouldDeploy}`,
              ].join(' | ');

              core.info(`Deployment inputs -> ${details}`);

              core.setOutput('branch', branch);
              core.setOutput('ref', ref);
              core.setOutput('safe_branch', safeBranch);
              core.setOutput('deploy_key', prNumber ? `pull-${prNumber}` : safeBranch);
              core.setOutput('pr_number', prNumber);
              core.setOutput('target_dir', targetDir);
              core.setOutput('preview_url', previewUrl);
              core.setOutput('should_deploy', shouldDeploy ? 'true' : 'false');
            } catch (error) {
              const reason = error?.message || String(error);
              await core.summary
                .addHeading('Deployment failed')
                .addRaw(reason)
                .write();
              core.setFailed(reason);
            }
      - name: Checkout source branch
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.compute.outputs.ref }}
          fetch-depth: 0
          path: source

      - name: Ensure gh-pages working tree
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        env:
          REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ -d pages/.git ]; then
            cd pages
            git fetch --depth 1 origin gh-pages || true
            git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages
            git reset --hard origin/gh-pages 2>/dev/null || true
            git clean -fdx
            exit 0
          fi

          rm -rf pages
          git clone --depth 1 --branch gh-pages "https://github.com/${REPOSITORY}.git" pages || true

          if [ ! -d pages/.git ]; then
            git clone --depth 1 "https://github.com/${REPOSITORY}.git" pages
            cd pages
            git checkout --orphan gh-pages
            git rm -rf .
          fi

      - name: Set up Node.js
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Prepare target directory
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        env:
          TARGET_BRANCH: ${{ steps.compute.outputs.branch }}
          SAFE_BRANCH: ${{ steps.compute.outputs.safe_branch }}
        run: |
          set -euo pipefail

          TARGET_DIR="${{ steps.compute.outputs.target_dir }}"
          ARTIFACT_PATH="pages"

          if [ -n "${TARGET_DIR}" ] && [ "${TARGET_DIR}" != "." ]; then
            ARTIFACT_PATH="pages/${TARGET_DIR}"
          fi

          mkdir -p "pages/${TARGET_DIR}/README" "pages/${TARGET_DIR}/AGENTS"
          echo "target_dir=${TARGET_DIR}" >> "$GITHUB_ENV"
          echo "artifact_path=${ARTIFACT_PATH}" >> "$GITHUB_ENV"

      - name: Sync runtime files
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        env:
          TARGET_DIR: ${{ env.target_dir }}
        run: |
          set -euo pipefail

          rsync -av --delete \
            --exclude '.git/' \
            --exclude 'project/' \
            --exclude '.github/' \
            source/ "pages/${TARGET_DIR}/"

      - name: Render docs for Pages
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        env:
          TARGET_DIR: ${{ env.target_dir }}
        run: |
          set -euo pipefail

          node ./source/project/scripts/build-pages-site.mjs \
            --source ./source/README.md \
            --output "pages/${TARGET_DIR}/README/index.html" \
            --context "${GITHUB_REPOSITORY}"
          node ./source/project/scripts/build-pages-site.mjs \
            --source ./source/AGENTS.md \
            --output "pages/${TARGET_DIR}/AGENTS/index.html" \
            --context "${GITHUB_REPOSITORY}" \
            --title "Capy Agent Guide" \
            --source-label "AGENTS.md"

      - name: Commit and push
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        env:
          TARGET_BRANCH: ${{ steps.compute.outputs.branch }}
          SAFE_BRANCH: ${{ steps.compute.outputs.safe_branch }}
          PREVIEW_URL: ${{ steps.compute.outputs.preview_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cd pages

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          git add .
          echo "::debug::Preview URL ${PREVIEW_URL}"
          echo "Preview URL: ${PREVIEW_URL}" | tee -a "$GITHUB_STEP_SUMMARY"

          if git diff --cached --quiet; then
            echo "No changes to deploy."
            exit 0
          fi

          git commit -m "Deploy ${TARGET_BRANCH} (${GITHUB_SHA})"
          git push origin gh-pages

      - name: Record deployment diagnostics
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        env:
          TARGET_BRANCH: ${{ steps.compute.outputs.branch }}
          TARGET_DIR: ${{ steps.compute.outputs.target_dir }}
          PREVIEW_URL: ${{ steps.compute.outputs.preview_url }}
          PR_NUMBER: ${{ steps.compute.outputs.pr_number }}
          DEPLOY_KEY: ${{ steps.compute.outputs.deploy_key }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail

          DEPLOY_PATH="pages/${TARGET_DIR:-.}"
          mkdir -p deployment-metadata

          pages_commit=$(cd pages && git rev-parse HEAD || echo "unknown")
          file_count=$(find "$DEPLOY_PATH" -type f | wc -l | tr -d ' ')
          index_status="missing"
          [ -f "${DEPLOY_PATH}/index.html" ] && index_status="present"

          cat > deployment-metadata/summary.json <<JSON
          {
            "branch": "${TARGET_BRANCH}",
            "pr_number": "${PR_NUMBER}",
            "deploy_key": "${DEPLOY_KEY}",
            "target_dir": "${TARGET_DIR:-.}",
            "preview_url": "${PREVIEW_URL}",
            "pages_commit": "${pages_commit}",
            "workflow_run_id": "${RUN_ID}",
            "file_count": ${file_count},
            "index_html": "${index_status}"
          }
          JSON

          {
            echo "Deployment diagnostics:"
            echo "  branch: ${TARGET_BRANCH}"
            echo "  preview: ${PREVIEW_URL}" 
            echo "  target dir: ${TARGET_DIR:-.}" 
            echo "  gh-pages commit: ${pages_commit}" 
            echo "  file count: ${file_count}" 
            echo "  index.html: ${index_status}" 
          } | tee deployment-metadata/summary.txt

      - name: Upload gh-pages artifact
        id: pages-artifact
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: gh-pages-${{ steps.compute.outputs.deploy_key }}
          path: ${{ env.artifact_path }}
          retention-days: 7

      - name: Upload deployment diagnostics
        id: diagnostics-artifact
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: gh-pages-diagnostics-${{ steps.compute.outputs.deploy_key }}
          path: deployment-metadata
          retention-days: 14

      - name: Publish deployment summary
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        env:
          PREVIEW_URL: ${{ steps.compute.outputs.preview_url }}
          TARGET_DIR: ${{ steps.compute.outputs.target_dir }}
          PAGES_ARTIFACT_URL: ${{ steps.pages-artifact.outputs.artifact-url }}
          DIAGNOSTICS_ARTIFACT_URL: ${{ steps.diagnostics-artifact.outputs.artifact-url }}
        run: |
          set -euo pipefail

          {
            echo "## Deployment details"
            echo "- Preview URL: ${PREVIEW_URL:-unavailable}"
            echo "- Target directory: ${TARGET_DIR:-.}"
            [ -n "${PAGES_ARTIFACT_URL:-}" ] && echo "- gh-pages artifact: ${PAGES_ARTIFACT_URL}"
            [ -n "${DIAGNOSTICS_ARTIFACT_URL:-}" ] && echo "- Diagnostics: ${DIAGNOSTICS_ARTIFACT_URL}"
            echo
            echo "### Diagnostics"
            sed 's/^/- /' deployment-metadata/summary.txt
          } | tee -a "$GITHUB_STEP_SUMMARY"

      - name: Publish deployment status
        if: ${{ steps.compute.outputs.should_deploy == 'true' }}
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.compute.outputs.preview_url }}
          REF: ${{ steps.compute.outputs.ref }}
          BRANCH: ${{ steps.compute.outputs.branch }}
          PR_NUMBER: ${{ steps.compute.outputs.pr_number }}
        with:
          script: |
            const previewUrl = process.env.PREVIEW_URL;

            if (!previewUrl) {
              core.info('No preview URL available; skipping deployment status.');
              return;
            }

            const ref = process.env.REF || context.ref;
            const prNumber = process.env.PR_NUMBER;
            const branch = process.env.BRANCH || context.ref.replace('refs/heads/', '');
            const environment = prNumber ? `pages/pr-${prNumber}` : 'pages/main';

            const { data: deployment } = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref,
              environment,
              auto_merge: false,
              required_contexts: [],
              description: `GitHub Pages preview for ${branch}`,
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.id,
              state: 'success',
              environment,
              environment_url: previewUrl,
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: 'Preview deployed to GitHub Pages',
            });

      - name: Record deployment failure
        if: failure()
        run: |
          echo "Deployment failed for branch '${{ steps.compute.outputs.branch || github.ref_name }}'. Check logs for details." >> "$GITHUB_STEP_SUMMARY"
