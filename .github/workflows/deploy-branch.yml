name: Deploy GitHub Pages previews

on:
  push:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      target_branch:
        description: Branch to deploy (defaults to the event branch)
        required: false
        default: ''

permissions:
  contents: write
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      BASE_PREVIEW_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
    steps:
      - name: Check out source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive target
        id: target
        run: |
          set -euo pipefail

          branch="${{ github.event.inputs.target_branch || github.ref_name }}"
          if [ -z "${branch}" ]; then
            echo "Branch name is required" >&2
            exit 1
          fi

          safe_branch=$(printf '%s' "${branch}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          if [ "${branch}" = "main" ]; then
            target_dir="."
            preview_url="${BASE_PREVIEW_URL}/"
          else
            target_dir="pull/${safe_branch}"
            preview_url="${BASE_PREVIEW_URL}/pull/${safe_branch}/"
          fi

          echo "branch=${branch}" >> "$GITHUB_OUTPUT"
          echo "safe_branch=${safe_branch}" >> "$GITHUB_OUTPUT"
          echo "target_dir=${target_dir}" >> "$GITHUB_OUTPUT"
          echo "preview_url=${preview_url}" >> "$GITHUB_OUTPUT"

          {
            echo "Branch: ${branch}"
            echo "Target directory: ${target_dir}"
            echo "Preview URL: ${preview_url}"
          } | tee -a "$GITHUB_STEP_SUMMARY"

      - name: Prepare gh-pages copy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          rm -rf pages
          git clone --depth 1 --branch gh-pages "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" pages 2>/dev/null || {
            git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" pages
            cd pages
            git checkout --orphan gh-pages
            git rm -rf . || true
          }

      - name: Copy site content
        env:
          TARGET_DIR: ${{ steps.target.outputs.target_dir }}
        run: |
          set -euo pipefail

          rm -rf "pages/${TARGET_DIR}"
          mkdir -p "pages/${TARGET_DIR}"

          rsync -av --delete \
            --exclude '.git/' \
            --exclude 'project/' \
            --exclude '.github/' \
            --exclude 'pages/' \
            ./ "pages/${TARGET_DIR}/"

      - name: Publish to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_BRANCH: ${{ steps.target.outputs.branch }}
        run: |
          set -euo pipefail
          cd pages

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to publish"
            exit 0
          fi

          git commit -m "Deploy ${TARGET_BRANCH} (${GITHUB_SHA})"
          git push origin gh-pages

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: gh-pages-${{ steps.target.outputs.safe_branch }}
          path: pages/${{ steps.target.outputs.target_dir }}
          retention-days: 7

      - name: Output preview link
        run: |
          echo "Preview: ${{ steps.target.outputs.preview_url }}" | tee -a "$GITHUB_STEP_SUMMARY"
