name: Deploy GitHub Pages previews

on:
  push:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      target_branch:
        description: Branch to deploy (defaults to the event branch)
        required: false
        default: ''
      allow_without_pr:
        description: Allow deployment when no open PR exists for the branch
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    env:
      BASE_PREVIEW_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
    steps:
      - name: Check out source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine deployment target
        id: target
        uses: actions/github-script@v7
        with:
          script: |
            const inputs = context.payload?.inputs || {};
            const branchInput = inputs.target_branch || '';
            const allowWithoutPrInput = inputs.allow_without_pr;
            const branch = branchInput || context.ref.replace('refs/heads/', '');
            const allowWithoutPr = String(allowWithoutPrInput).toLowerCase() === 'true';

            if (!branch) {
              core.setFailed('Branch name is required');
              return;
            }

            const basePreview = process.env.BASE_PREVIEW_URL;
            const safeBranch = branch.replace(/[^a-zA-Z0-9._-]/g, '-');

            let prNumber = undefined;
            try {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch}`,
                state: 'open',
                per_page: 1,
              });

              prNumber = prs[0]?.number;
            } catch (error) {
              core.warning(`Failed to look up PR for ${branch}: ${error.message}`);
            }

            const targetDir = branch === 'main'
              ? '.'
              : prNumber
                ? `pull/${prNumber}`
                : `pull/${safeBranch}`;

            const previewUrl = targetDir === '.'
              ? `${basePreview}/`
              : `${basePreview}/${targetDir}/`;

            const shouldSkip = branch !== 'main' && !prNumber && !allowWithoutPr;

            const summaryLines = [
              `Branch: ${branch}`,
              prNumber ? `PR: #${prNumber}` : 'PR: none found',
              `Target directory: ${targetDir}`,
              `Preview URL: ${previewUrl}`,
            ];

            if (shouldSkip) {
              summaryLines.push('Deployment skipped: branch has no open PR (override with allow_without_pr).');
            }

            core.setOutput('branch', branch);
            core.setOutput('safe_branch', safeBranch);
            core.setOutput('pr', prNumber ? String(prNumber) : '');
            core.setOutput('target_dir', targetDir);
            core.setOutput('preview_url', previewUrl);
            core.setOutput('skip', shouldSkip ? 'true' : 'false');

            core.summary.addRaw(summaryLines.join('\n')).write();

      - name: Retrieve existing gh-pages content
        if: steps.target.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          rm -rf pages

          if git ls-remote --exit-code --heads "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" gh-pages; then
            git clone --depth 1 --branch gh-pages "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" pages
          else
            git clone --depth 1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" pages
            rm -rf pages/*
          fi

          rm -rf pages/.git

      - name: Prepare site content
        if: steps.target.outputs.skip != 'true'
        env:
          TARGET_DIR: ${{ steps.target.outputs.target_dir }}
        run: |
          set -euo pipefail

          DEST_DIR="pages/${TARGET_DIR}"

          if [ "${TARGET_DIR}" = "." ]; then
            DEST_DIR="pages"
            mkdir -p "${DEST_DIR}"
            rsync -av --delete \
              --exclude '.git/' \
              --exclude 'project/' \
              --exclude '.github/' \
              --exclude 'pages/' \
              --exclude 'pull/' \
              --exclude 'README/' \
              ./ "${DEST_DIR}/"
          else
            rm -rf "${DEST_DIR}"
            mkdir -p "${DEST_DIR}"
            rsync -av --delete \
              --exclude '.git/' \
              --exclude 'project/' \
              --exclude '.github/' \
              --exclude 'pages/' \
              ./ "${DEST_DIR}/"
          fi

      - name: Capture deployment directory listing
        if: steps.target.outputs.skip != 'true'
        env:
          TARGET_DIR: ${{ steps.target.outputs.target_dir }}
        run: |
          set -euo pipefail

          LIST_PATH="pages/${TARGET_DIR}"
          echo "Listing contents for ${LIST_PATH}" > deployment-directory-listing.txt
          ls -la "${LIST_PATH}" | tee -a deployment-directory-listing.txt

      - name: Upload Pages artifact
        if: steps.target.outputs.skip != 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages
          name: github-pages-${{ github.run_attempt }}

      - name: Deploy to GitHub Pages
        if: steps.target.outputs.skip != 'true'
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages-${{ github.run_attempt }}

      - name: Output preview link
        if: steps.target.outputs.skip != 'true'
        env:
          TARGET_DIR: ${{ steps.target.outputs.target_dir }}
        run: |
          {
            echo "Preview: ${{ steps.target.outputs.preview_url }}"
            echo ""
            echo "Deployment directory listing (pages/${TARGET_DIR}):"
            echo '```'
            cat deployment-directory-listing.txt
            echo '```'
          } | tee -a "$GITHUB_STEP_SUMMARY"
