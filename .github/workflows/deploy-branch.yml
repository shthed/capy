name: Deploy GitHub Pages previews

on:
  push:
    branches: ["**"]
  workflow_dispatch:
    inputs:
      target_branch:
        description: Branch to deploy (defaults to main when blank)
        required: false
        default: ''

permissions:
  contents: write
  actions: read
  pull-requests: read

env:
  BASE_PREVIEW_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}

jobs:
  plan:
    name: Plan deployment
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.compute.outputs.branch }}
      ref: ${{ steps.compute.outputs.ref }}
      safe_branch: ${{ steps.compute.outputs.safe_branch }}
      preview_url: ${{ steps.compute.outputs.preview_url }}
    steps:
      - name: Derive deployment target
        id: compute
        uses: actions/github-script@v7
        with:
          script: |
            const inputBranch = core.getInput('target_branch');

            const sanitize = (value) => (value || '').replace(/[^a-zA-Z0-9._-]/g, '-').trim();

            const resolveBranchRef = async (branchName) => {
              if (!branchName) {
                return { branch: '', ref: '' };
              }
              const { data } = await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName,
              });
              return { branch: branchName, ref: data?.commit?.sha || '' };
            };

            try {
              const eventName = context.eventName;
              let branch = '';
              let ref = '';

              if (eventName === 'push') {
                branch = (context.payload.ref || '').replace('refs/heads/', '');
                ref = context.sha;
              } else if (eventName === 'workflow_dispatch') {
                const target = inputBranch || 'main';
                const resolved = await resolveBranchRef(target);
                branch = resolved.branch;
                ref = resolved.ref;
              }

              if (!branch) {
                const message = 'No branch could be resolved for deployment.';
                await core.summary.addHeading('Deployment failed').addRaw(message).write();
                core.setFailed(message);
                return;
              }

              const safeBranch = sanitize(branch);
              const isMain = branch === 'main';

              const baseUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}`;
              const previewUrl = isMain
                ? `${baseUrl}/`
                : `${baseUrl}/${safeBranch}/`;

              core.setOutput('branch', branch);
              core.setOutput('ref', ref);
              core.setOutput('safe_branch', safeBranch || branch);
              core.setOutput('preview_url', previewUrl);
            } catch (error) {
              const reason = error?.message || String(error);
              await core.summary
                .addHeading('Deployment failed')
                .addRaw(reason)
                .write();
              core.setFailed(reason);
            }
  deploy:
    name: Deploy branch preview
    needs: plan
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-pages-${{ needs.plan.outputs.safe_branch }}
      cancel-in-progress: false
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.plan.outputs.ref }}
          fetch-depth: 0
          path: source

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: pages
          fetch-depth: 0

      - name: Ensure gh-pages working tree
        env:
          REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ -d pages/.git ]; then
            exit 0
          fi

          rm -rf pages
          git clone --depth 1 --branch gh-pages "https://github.com/${REPOSITORY}.git" pages || true

          if [ ! -d pages/.git ]; then
            git clone --depth 1 "https://github.com/${REPOSITORY}.git" pages
            cd pages
            git checkout --orphan gh-pages
            git rm -rf .
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Prepare target directory
        env:
          TARGET_BRANCH: ${{ needs.plan.outputs.branch }}
          SAFE_BRANCH: ${{ needs.plan.outputs.safe_branch }}
        run: |
          set -euo pipefail

          TARGET_DIR="pages"
          if [ "${TARGET_BRANCH}" != "main" ]; then
            TARGET_DIR="pages/${SAFE_BRANCH}"
          fi

          mkdir -p "${TARGET_DIR}/README"
          echo "target_dir=${TARGET_DIR}" >> "$GITHUB_ENV"

      - name: Sync runtime files
        env:
          TARGET_DIR: ${{ env.target_dir }}
        run: |
          set -euo pipefail

          rsync -av --delete \
            --include 'index.html' \
            --include 'capy.json' \
            --include 'render.js' \
            --include 'render-canvas2d.js' \
            --include 'render-webgl.js' \
            --include 'render-svg.js' \
            --include 'runtime.js' \
            --include 'puzzle-generation.js' \
            --include 'ui-template.js' \
            --include 'styles.css' \
            --include 'service-worker.js' \
            --include 'README.md' \
            --include 'ROADMAP.md' \
            --include 'TODO.md' \
            --exclude '*' \
            source/ "${TARGET_DIR}/"

      - name: Render README for Pages
        env:
          TARGET_DIR: ${{ env.target_dir }}
        run: |
          set -euo pipefail

          node ./source/project/scripts/build-pages-site.mjs \
            --source ./source/README.md \
            --output "${TARGET_DIR}/README/index.html" \
            --context "${GITHUB_REPOSITORY}"

      - name: Commit and push
        env:
          TARGET_BRANCH: ${{ needs.plan.outputs.branch }}
          SAFE_BRANCH: ${{ needs.plan.outputs.safe_branch }}
          PREVIEW_URL: ${{ needs.plan.outputs.preview_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cd pages

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to deploy."
            exit 0
          fi

          git commit -m "Deploy ${TARGET_BRANCH} (${GITHUB_SHA})"
          git push origin gh-pages

          echo "Preview URL: ${PREVIEW_URL}" >> "$GITHUB_STEP_SUMMARY"

      - name: Record deployment failure
        if: failure()
        run: |
          echo "Deployment failed for branch '${{ needs.plan.outputs.branch }}'. Check logs for details." >> "$GITHUB_STEP_SUMMARY"
