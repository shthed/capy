name: Deploy GitHub Pages previews

on:
  push:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      target_branch:
        description: Branch to deploy (defaults to the event branch)
        required: false
        default: ''

permissions:
  contents: write
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      BASE_PREVIEW_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
    steps:
      - name: Check out source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive target
        id: target
        uses: actions/github-script@v7
        with:
          script: |
            const branchInput = (context.payload?.inputs || {}).target_branch;
            const branch = branchInput || context.ref.replace('refs/heads/', '');

            if (!branch) {
              core.setFailed('Branch name is required');
              return;
            }

            const basePreview = process.env.BASE_PREVIEW_URL;
            const safeBranch = branch.replace(/[^a-zA-Z0-9._-]/g, '-');

            let prNumber = undefined;
            try {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch}`,
                state: 'open',
                per_page: 1,
              });

              prNumber = prs[0]?.number;
            } catch (error) {
              core.warning(`Failed to look up PR for ${branch}: ${error.message}`);
            }

            const targetDir = branch === 'main'
              ? '.'
              : prNumber
                ? `pull/${prNumber}`
                : `pull/${safeBranch}`;

            const previewUrl = targetDir === '.'
              ? `${basePreview}/`
              : `${basePreview}/${targetDir}/`;

            const summaryLines = [
              `Branch: ${branch}`,
              prNumber ? `PR: #${prNumber}` : 'PR: none found (falling back to branch slug)',
              `Target directory: ${targetDir}`,
              `Preview URL: ${previewUrl}`,
            ];

            core.setOutput('branch', branch);
            core.setOutput('safe_branch', safeBranch);
            core.setOutput('pr', prNumber ? String(prNumber) : '');
            core.setOutput('target_dir', targetDir);
            core.setOutput('preview_url', previewUrl);
            core.setOutput('artifact_name', prNumber ? `gh-pages-pr-${prNumber}` : `gh-pages-${safeBranch}`);

            core.summary.addRaw(summaryLines.join('\n')).write();

      - name: Prepare gh-pages copy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          rm -rf pages
          git clone --depth 1 --branch gh-pages "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" pages 2>/dev/null || {
            git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" pages
            cd pages
            git checkout --orphan gh-pages
            git rm -rf . || true
          }

      - name: Copy site content
        env:
          TARGET_DIR: ${{ steps.target.outputs.target_dir }}
        run: |
          set -euo pipefail

          rm -rf "pages/${TARGET_DIR}"
          mkdir -p "pages/${TARGET_DIR}"

          rsync -av --delete \
            --exclude '.git/' \
            --exclude 'project/' \
            --exclude '.github/' \
            --exclude 'pages/' \
            ./ "pages/${TARGET_DIR}/"

      - name: Stage deployment artifact
        env:
          TARGET_DIR: ${{ steps.target.outputs.target_dir }}
        run: |
          set -euo pipefail

          rm -rf artifact
          mkdir -p "artifact/${TARGET_DIR}"

          rsync -av --delete "pages/${TARGET_DIR}/" "artifact/${TARGET_DIR}/"

      - name: Publish to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_BRANCH: ${{ steps.target.outputs.branch }}
        run: |
          set -euo pipefail
          cd pages

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to publish"
            exit 0
          fi

          git commit -m "Deploy ${TARGET_BRANCH} (${GITHUB_SHA})"
          git push origin gh-pages

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.target.outputs.artifact_name }}
          path: artifact
          retention-days: 7

      - name: Output preview link
        run: |
          echo "Preview: ${{ steps.target.outputs.preview_url }}" | tee -a "$GITHUB_STEP_SUMMARY"
