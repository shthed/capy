name: Post-deploy branch tests

on:
  workflow_run:
    workflows:
      - Deploy GitHub Pages previews
    types:
      - completed

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  slug:
    runs-on: ubuntu-latest
    outputs:
      branch_slug: ${{ steps.slug.outputs.branch_slug }}
    steps:
      - name: Derive branch slug
        id: slug
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch || '' }}
        run: |
          set -euo pipefail

          SAFE_BRANCH=$(printf '%s' "${HEAD_BRANCH}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "branch_slug=${SAFE_BRANCH}" >> "$GITHUB_OUTPUT"

  review:
    needs: slug
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch != null &&
      github.event.workflow_run.head_branch != ''
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: project
    concurrency:
      group: post-deploy-tests-${{ needs.slug.outputs.branch_slug }}
      cancel-in-progress: true
    steps:
      - name: Checkout branch commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: project/package-lock.json

      - name: Install dependencies
        working-directory: project
        run: npm ci

      - name: Install Playwright browsers
        working-directory: project
        run: npx playwright install --with-deps

      - name: Derive Pages preview URL
        id: preview
        env:
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
        run: |
          set -euo pipefail

          SAFE_NAME=$(printf '%s' "${BRANCH_NAME}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          BASE_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}"

          if [ "${BRANCH_NAME}" = "main" ]; then
            PREVIEW_URL="${BASE_URL}/"
          else
            PREVIEW_URL="${BASE_URL}/${SAFE_NAME}/"
          fi

          echo "preview_url=${PREVIEW_URL}" >> "$GITHUB_OUTPUT"
          echo "Preview URL: ${PREVIEW_URL}"

      - name: Prepare UI review artifacts directory
        working-directory: project
        run: |
          set -euo pipefail
          rm -rf artifacts/ui-review
          mkdir -p artifacts/ui-review
      - name: Run Playwright smoke tests
        id: smoke
        continue-on-error: true
        env:
          PREVIEW_URL: ${{ steps.preview.outputs.preview_url }}
          PLAYWRIGHT_BASE_URL: ${{ steps.preview.outputs.preview_url }}
        working-directory: project
        run: |
          set -euo pipefail
          npm test --silent 2>&1 | tee artifacts/ui-review/smoke.log

      - name: Capture preview screenshot
        if: always()
        env:
          PLAYWRIGHT_BASE_URL: ${{ steps.preview.outputs.preview_url }}
        working-directory: project
        run: |
          set -euo pipefail
          node ./scripts/capture-preview-screenshot.js

      - name: Collect smoke test errors
        id: smoke-summary
        if: always()
        working-directory: project
        run: |
          set -euo pipefail

          outcome="${{ steps.smoke.outcome }}"
          echo "outcome=${outcome}" >> "$GITHUB_OUTPUT"

          if [ "$outcome" != "success" ] && [ -f artifacts/ui-review/smoke.log ]; then
            {
              printf 'errors<<EOF\n'
              tail -n 40 artifacts/ui-review/smoke.log
              printf '\nEOF\n'
            } >> "$GITHUB_OUTPUT"
          else
            echo "errors=" >> "$GITHUB_OUTPUT"
          fi

      - name: Capture preview screenshot
        id: capture-screenshot
        if: always()
        continue-on-error: true
        env:
          PREVIEW_URL: ${{ steps.preview.outputs.preview_url }}
        working-directory: project
        run: |
          set -euo pipefail

          if [ -z "${PREVIEW_URL:-}" ]; then
            echo "Preview URL missing; skipping screenshot capture."
            exit 0
          fi

          node --input-type=module - <<'NODE'
          import { chromium } from 'playwright';

          const url = process.env.PREVIEW_URL;
          const outputPath = 'artifacts/ui-review/preview.png';

          const browser = await chromium.launch({ headless: true });
          const context = await browser.newContext({ viewport: { width: 1280, height: 720 } });
          const page = await context.newPage();

          try {
            await page.goto(url, { waitUntil: 'networkidle', timeout: 15000 });
            await page.screenshot({ path: outputPath, fullPage: true });
            console.log(`Captured preview screenshot at ${outputPath}`);
          } finally {
            await browser.close();
          }
          NODE

      - name: Detect UI review artifacts
        id: artifact-check
        if: always()
        working-directory: project
        run: |
          set -euo pipefail

          if [ -d "artifacts/ui-review" ] && find "artifacts/ui-review" -type f -print -quit | grep -q .; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload UI review artifacts
        if: always()
        id: upload-ui-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ui-review-${{ needs.slug.outputs.branch_slug }}-${{ github.run_id }}
          path: project/artifacts/ui-review
          if-no-files-found: ignore

      - name: Share preview link on PR
        if: always()
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.preview.outputs.preview_url }}
          SMOKE_OUTCOME: ${{ steps.smoke-summary.outputs.outcome }}
          ERROR_MESSAGES: ${{ steps.smoke-summary.outputs.errors }}
          ARTIFACT_FOUND: ${{ steps.artifact-check.outputs.found }}
          ARTIFACT_URL: ${{ steps.upload-ui-artifacts.outputs.artifact-url }}
        with:
          script: |
            const pullRequests = context.payload.workflow_run?.pull_requests ?? [];
            if (!Array.isArray(pullRequests) || pullRequests.length === 0) {
              core.info('No pull requests attached to this run. Skipping comment.');
              return;
            }

            const previewUrl = process.env.PREVIEW_URL;
            const smokeOutcome = process.env.SMOKE_OUTCOME;
            const errors = process.env.ERROR_MESSAGES;
            const artifactFound = process.env.ARTIFACT_FOUND === 'true';
            const artifactUrl = process.env.ARTIFACT_URL;
            const rerunUrl = context.payload.workflow_run?.html_url;

            const lines = [];

            if (previewUrl) {
              lines.push(`Preview updated: ${previewUrl}`);
            }

            if (smokeOutcome && smokeOutcome !== 'success') {
              lines.push('Smoke tests failed.');
            }

            if (errors) {
              lines.push('Errors:\n```\n' + errors.trimEnd() + '\n```');
            }

            if (artifactFound && artifactUrl) {
              lines.push(`UI review artifacts: ${artifactUrl}`);
            }

            if (lines.length === 0) {
              lines.push('Preview link unavailable.');
            }

            if (rerunUrl) {
              lines.push(`[üîÅ Rerun Pages deploy](${rerunUrl})`);
            }

            const body = lines.join('\n\n');

            for (const pr of pullRequests) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body,
              });
            }
