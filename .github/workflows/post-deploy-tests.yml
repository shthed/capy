name: Post-deploy branch tests

on:
  workflow_run:
    workflows:
      - Deploy GitHub Pages previews
    types:
      - completed

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare summary
        id: summary
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run || {};
            const pullRequests = run.pull_requests || [];

            if (!Array.isArray(pullRequests) || pullRequests.length === 0) {
              core.info('No pull request attached to this run.');
              return;
            }

            const branch = run.head_branch || pullRequests[0]?.head?.ref || '';
            const safeBranch = (branch || '').replace(/[^a-zA-Z0-9._-]/g, '-');
            const previewBase = `https://${context.repo.owner}.github.io/${context.repo.repo}`;
            const targetDir = branch === 'main' ? '' : `pull/${safeBranch}`;
            const previewUrl = targetDir ? `${previewBase}/${targetDir}/` : `${previewBase}/`;
            const runUrl = run.html_url;

            const artifacts = await github.paginate(github.rest.actions.listWorkflowRunArtifacts, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id,
              per_page: 100,
            });

            const artifact = artifacts.find((item) => item.name === `gh-pages-${safeBranch}`);
            const artifactUrl = artifact?.archive_download_url || '';
            const testsUrl = runUrl;

            const timestamp = new Date().toISOString().replace('T', ' ').replace(/\.\d+Z$/, ' UTC');
            const link = (label, url) => (url ? `[${label}](${url})` : `${label}: unavailable`);

            const entry = [
              link('Run', runUrl),
              link('Preview', previewUrl),
              link('Tests', testsUrl),
              artifactUrl ? link('Artifact', artifactUrl) : 'Artifact: unavailable',
              link('Rerun', runUrl),
            ].join(' · ');

            const body = `Branch preview deployments\n<!-- capy-pages-preview -->\n- ${timestamp} · ${entry}`;

            core.setOutput('body', body);
            core.setOutput('pr', String(pullRequests[0].number));

      - name: Comment on PR
        if: ${{ steps.summary.outputs.body && steps.summary.outputs.pr }}
        uses: actions/github-script@v7
        env:
          BODY: ${{ steps.summary.outputs.body }}
          PR: ${{ steps.summary.outputs.pr }}
        with:
          script: |
            const body = process.env.BODY;
            const issueNumber = Number(process.env.PR);

            if (!body || !issueNumber) {
              core.info('Nothing to comment.');
              return;
            }

            const marker = '<!-- capy-pages-preview -->';

            const existingComment = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100,
            }).then((comments) => comments.find((comment) => comment.user?.login === 'github-actions[bot]' && comment.body?.includes(marker)));

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body,
              });
            }
