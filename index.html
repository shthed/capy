<!DOCTYPE html>
<html lang="en">
  <!--
    Developer Map
    ==========
    Layout overview
    --------------
    - UI chrome (command rail, modal sheets, and the debug console) exposes primary actions wired
      to script handlers. Scan for "Command button" listeners when adjusting layout interactions.
    - Viewport + stage: #viewport, #canvasStage, and #canvasTransform cooperate with viewState for
      pan/zoom. Pointer handlers (handlePanStart/Move/End) and applyZoom feed navigation updates.
    - Puzzle state & rendering: state holds palette, fills, and metadata. renderPuzzle →
      drawOutlines/drawNumbers use ensureRenderCache to hydrate canvases and labels.
    - Generation pipeline: loadImage → createPuzzleData orchestrates quantization, segmentation,
      and palette prep. Regeneration, fixture loading, and saves all call applyPuzzleResult.
    - Persistence + exports: createGameSaveManager backs the Saves sheet. Autosave,
      manual saves, and exports live alongside serializeCurrentPuzzle.
    - External API: window.capyGenerator exposes devtools entry points; keep signatures stable when
      reorganizing internal wiring.

    Script organization
    -------------------
    1. Cached DOM references, constants, and default settings.
    2. Canvas metrics, view state, pointer capture, and custom cursor helpers.
    3. Generation + rendering pipeline (loadDefaultPuzzle, createPuzzleData, renderPuzzle, etc.).
    4. Palette interactions, keyboard/mouse handlers, and hint overlay animation loop.
    5. Autosave + storage encoding, save manager wiring, and UI refresh routines.
    6. window.capyGenerator bindings exported last for manual QA tooling.

    Function highlights
    -------------------
    - installBrowserZoomGuards(): Prevents browser zoom from intercepting wheel gestures on the
      canvas.
    - applyViewTransform(options): Pushes viewState pan/zoom changes to the stage and pointer
      overlays.
    - applyZoom(multiplier, clientX, clientY, options): Normalizes zoom gestures around the pointer
      focus and updates viewState.
    - resetView(options): Fits the puzzle to the viewport and recenters the stage.
    - loadSamplePuzzle(options) / loadDefaultPuzzle(options): Bootstrap the bundled sample or
      fallback puzzle payload.
    - createPuzzleData(image, options): Invokes the generation worker to quantize colors and
      segment regions.
    - applyPuzzleResult(data, metadata): Hydrates puzzle state, triggers canvas redraw, and updates
      metadata surfaces.
    - renderPuzzle() / renderPreview(): Draw the active puzzle and thumbnail preview using the
      shared render cache.
    - renderPalette(): Rebuilds the palette dock and accessibility metadata for the active colors.
    - attemptFillRegion(hit, { label }): Processes paint interactions, updates fills, and schedules
      autosave.
    - useHint(): Coordinates palette flashing + overlay animations to guide the next region.
    - updateCommandStates(): Enables/disables command rail buttons based on current puzzle state.
    - applyTheme(theme, options) / applyBackgroundColor(hex, options): Refresh UI theming tokens and
      persist preferences.
    - scheduleAutosave(reason) / persistAutosave(reason): Manage background save cadence and writes
      to storage.
    - saveCurrentSnapshot(): Captures a manual save entry and refreshes manager lists.
    - refreshGameSelection() / refreshSaveList(): Render save management surfaces from shared
      templates.
    - createGameSaveManager(): Wraps persistence with list, subscribe, and persist helpers for UI
      consumers.
  -->
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Image to Color-by-Number</title>
    <style>
      :root {
        --ui-scale-user: 1;
        --ui-scale-auto: 1;
        --ui-scale: calc(var(--ui-scale-user, 1) * var(--ui-scale-auto, 1));
        --app-width: 100vw;
        --app-height: 100vh;
        --viewport-padding: calc(32px * var(--ui-scale));
        --rail-padding-block: calc(10px * var(--ui-scale));
        --rail-padding-inline: calc(20px * var(--ui-scale));
      }
    </style>
    <link rel="preload" href="./styles.css" as="style" />
    <link rel="stylesheet" href="./styles.css" />

  </head>
  <body data-theme="dark">
    <script type="module" src="./capy.js"></script>
    <!-- Toast notifications -->
    <div
      id="errorToast"
      class="error-toast"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
      tabindex="-1"
      hidden
    >
      <div class="error-toast__content">
        <div class="error-toast__header">
          <p class="error-toast__title">Something went wrong</p>
          <div class="error-toast__actions">
            <button
              type="button"
              class="error-toast__copy"
              data-error-copy
              aria-label="Copy error details to clipboard"
            >
              Copy error
            </button>
            <button
              type="button"
              class="error-toast__close"
              data-error-close
              aria-label="Dismiss error notification"
            >
              ×
            </button>
          </div>
        </div>
        <p class="error-toast__message" data-error-message></p>
        <pre class="error-toast__stack" data-error-stack aria-label="Error details"></pre>
      </div>
    </div>
    <div id="app">
      <header id="commandRail" aria-label="Game controls">
        <button
          id="settingsButton"
          class="menu-button settings-launcher"
          type="button"
          data-testid="settings-button"
          aria-haspopup="dialog"
          aria-expanded="false"
          aria-label="Open menu"
          title="Open menu"
        >
          <span class="icon" aria-hidden="true">⚙</span>
          <span class="label visually-hidden">Menu</span>
        </button>
      </header>
      <section
        id="startHint"
        class="hidden"
        role="region"
        aria-label="Getting started"
        aria-hidden="true"
        tabindex="0"
      >
        <div class="start-hint__header">
          <div class="start-hint__badge" aria-hidden="true">✦</div>
          <div class="start-hint__titles">
            <p class="start-hint__eyebrow">New session</p>
            <p class="start-hint__title">Choose how to start coloring</p>
          </div>
        </div>
        <p class="start-hint-copy">Pick a starting point and we will build your palette and canvas below.</p>
        <ul class="start-hint-list">
          <li>Drop an image or Capy save anywhere in the window.</li>
          <li>Press Enter while this card is focused to choose a file.</li>
          <li>Open the menu to load the bundled capybara sample.</li>
        </ul>
        <div class="start-hint-actions">
          <button id="startHintUpload" class="start-hint-button start-hint-button--primary" type="button">
            Upload image or save
          </button>
          <button id="closeStartHint" class="start-hint-button" type="button">Open menu</button>
        </div>
      </section>
      <!-- Canvas viewport -->
      <div id="viewport">
        <div id="canvasStage">
          <div id="canvasTransform">
            <div
              id="puzzleCanvas"
              data-testid="puzzle-canvas"
              aria-label="Puzzle surface"
              role="presentation"
              style="width: 640px; height: 480px"
            ></div>
          </div>
        </div>
        <div id="pointerOverlay" aria-hidden="true">
          <div class="pointer-indicator"></div>
          <div class="pointer-tooltip">
            <span class="pointer-swatch" data-pointer-color-swatch aria-hidden="true"></span>
            <strong class="pointer-number" data-pointer-number></strong>
          </div>
        </div>
      </div>
      <!-- Palette dock -->
      <footer id="paletteDock" aria-label="Palette dock" data-testid="palette-dock">
        <div id="palette" role="list"></div>
      </footer>
    </div>
    <input id="fileInput" type="file" accept=".json,.capy,image/*" hidden />
    <!-- Settings sheet -->
    <div
      id="settingsSheet"
      class="sheet hidden"
      role="dialog"
      aria-label="Game menu"
      aria-hidden="true"
    >
      <div class="sheet-header">
        <div class="sheet-header-actions sheet-header-actions--start">
          <button
            id="settingsUploadButton"
            class="settings-upload"
            type="button"
            aria-label="Upload image or JSON puzzle"
          >
            Upload image
          </button>
        </div>
        <div class="sheet-heading">
          <p class="sheet-heading__hint">Menu</p>
        </div>
        <div class="sheet-header-actions">
          <button
            type="button"
            class="close-button sheet-close sheet-close--balanced"
            data-sheet-close="settings"
            aria-label="Close menu"
          >
            <span aria-hidden="true">×</span>
            <span class="visually-hidden">Close</span>
          </button>
        </div>
      </div>
      <div class="sheet-body">
        <div class="settings-body">
          <div class="settings-nav">
            <nav class="settings-tabs" role="tablist" aria-label="Menu sections" data-settings-nav></nav>
          </div>
          <div class="settings-content" data-settings-scroll></div>
        </div>
      </div>
    </div>
  </body>
</html>
